Введение
Ядро Linux поддерживает набор BPF-хуков в сетевом стеке, которые могут использоваться для выполнения BPF-программ. Датаплан Cilium использует эти хуки для загрузки BPF-программ, которые в совокупности создают высокоуровневые сетевые конструкции.

Ниже приведен список хуков, используемых Cilium, с кратким описанием. Для более подробной документации о каждом хуке см. BPF and XDP Reference Guide.

XDP: XDP BPF-хук находится в самой ранней точке сетевого драйвера и запускает выполнение BPF-программы при получении пакета. Это обеспечивает наилучшую производительность обработки пакетов, поскольку программа выполняется непосредственно на данных пакета до какой-либо другой обработки. Этот хук идеально подходит для запуска фильтрующих программ, которые отбрасывают вредоносный или неожиданный трафик, а также других механизмов защиты от DDoS.

Traffic Control Ingress/Egress: BPF-программы, прикрепленные к хуку traffic control (tc) ingress, присоединяются к сетевому интерфейсу, как и XDP, но выполняются после первоначальной обработки пакета сетевым стеком. Хук выполняется до L3-уровня стека, но имеет доступ к большинству метаданных, связанных с пакетом. Это идеально подходит для локальной обработки на узле, такой как применение политик конечных точек L3/L4 и перенаправление трафика к конечным точкам. Для сетевых устройств хук tc ingress может быть объединен с вышеупомянутым XDP-хуком. В этом случае можно предположить, что большая часть трафика на этом этапе является легитимной и предназначена для хоста.

Контейнеры обычно используют виртуальное устройство, называемое veth pair, которое действует как виртуальный провод, соединяющий контейнер с хостом. Присоединяясь к хуку TC ingress на стороне хоста этого veth pair, Cilium может контролировать и применять политики ко всему трафику, выходящему из контейнера. Прикрепляя BPF-программу к veth pair, связанному с каждым контейнером, и маршрутизируя весь сетевой трафик к виртуальным устройствам на стороне хоста с другой BPF-программой, прикрепленной к хуку tc ingress, Cilium может контролировать и применять политики ко всему трафику, входящему на узел или выходящему из него.

Socket operations: Хук socket operations прикрепляется к определенной cgroup и выполняется при TCP-событиях. Cilium прикрепляет BPF-программу socket operations к корневой cgroup и использует ее для отслеживания переходов TCP-состояний, особенно переходов в состояние ESTABLISHED. Когда сокет переходит в состояние ESTABLISHED, если TCP-сокет имеет локальный для узла пир (возможно, локальный прокси), прикрепляется программа socket send/recv.

Socket send/recv: Хук socket send/recv выполняется при каждой операции отправки, выполняемой TCP-сокетом. На этом этапе хук может проверить сообщение и либо отбросить его, либо отправить на TCP-уровень, либо перенаправить на другой сокет. Cilium использует это для ускорения перенаправлений в датаплейне, как описано ниже.

Объединяя вышеуказанные хуки с виртуальными интерфейсами (cilium_host, cilium_net), опциональным overlay-интерфейсом (cilium_vxlan), поддержкой криптографии в ядре Linux и пользовательским прокси (Envoy), Cilium создает следующие сетевые объекты.

Prefilter: Объект prefilter запускает XDP-программу и предоставляет набор правил предварительной фильтрации, используемых для фильтрации трафика из сети для достижения наилучшей производительности. В частности, используется набор CIDR-карт, предоставляемых агентом Cilium, для выполнения поиска, и пакет либо отбрасывается (например, когда пункт назначения не является допустимой конечной точкой), либо разрешается для обработки стеком. Это можно легко расширить по мере необходимости для добавления новых критериев/возможностей предварительной фильтрации.

Endpoint Policy: Объект endpoint policy реализует enforcement конечных точек Cilium. Используя карту для поиска идентификатора и политики, связанных с пакетом, этот уровень хорошо масштабируется для большого количества конечных точек. В зависимости от политики этот уровень может отбросить пакет, перенаправить его на локальную конечную точку, перенаправить на объект Service или перенаправить на объект L7 Policy для дальнейших правил L7. Это основной объект в датаплейне Cilium, отвечающий за сопоставление пакетов с идентификаторами и применение политик L3 и L4.

Service: Объект Service выполняет поиск по карте для IP-адреса назначения и, опционально, порта назначения для каждого полученного пакета. Если найдено совпадение, пакет будет перенаправлен на одну из настроенных конечных точек L3/L4. Блок Service может использоваться для реализации автономного балансировщика нагрузки на любом интерфейсе с использованием хука TC ingress или может быть интегрирован в объект endpoint policy.

L3 Encryption: На ingress объект L3 Encryption помечает пакеты для расшифровки, передает их в слой xfrm (transform) Linux для расшифровки, и после расшифровки пакета объект получает пакет, а затем передает его вверх по стеку для дальнейшей обработки другими объектами. В зависимости от режима (прямая маршрутизация или overlay) это может быть BPF tail call или стек маршрутизации Linux, который передает пакет следующему объекту. Ключ, необходимый для расшифровки, закодирован в заголовке IPsec, поэтому на ingress нам не нужно выполнять поиск по карте, чтобы найти ключ расшифровки.

На egress сначала выполняется поиск по карте с использованием IP-адреса назначения, чтобы определить, должен ли пакет быть зашифрован, и если да, то какие ключи доступны на узле назначения. Выбирается самый последний ключ, доступный на обоих узлах, и пакет помечается для шифрования. Затем пакет передается в слой xfrm Linux, где он шифруется. После получения зашифрованного пакета он передается следующему уровню либо путем отправки в стек Linux для маршрутизации, либо путем выполнения прямого tail call, если используется overlay.

Socket Layer Enforcement: Socket layer enforcement использует два хука (socket operations hook и socket send/recv hook) для мониторинга и присоединения ко всем TCP-сокетам, связанным с конечными точками, управляемыми Cilium, включая любые L7-прокси. Хук socket operations будет идентифицировать кандидатов на ускорение. К ним относятся все локальные соединения между узлами (от конечной точки к конечной точке) и любые соединения с прокси Cilium. Затем все сообщения этих идентифицированных соединений будут обрабатываться хуком socket send/recv. Быстрое перенаправление гарантирует, что все политики, реализованные в Cilium, действительны для соответствующего сопоставления сокет/конечная точка, и, если это так, отправляет сообщение непосредственно на peer-сокет.

L7 Policy: Объект L7 Policy перенаправляет прокси-трафик на экземпляр пользовательского прокси Cilium. Cilium использует экземпляр Envoy в качестве своего пользовательского прокси. Envoy затем либо перенаправит трафик, либо сгенерирует соответствующие сообщения об отклонении на основе настроенной политики L7.

Эти компоненты соединены вместе, чтобы создать гибкий и эффективный датаплейн, используемый Cilium. Ниже мы покажем следующие возможные потоки: соединение конечных точек на одном узле, ingress к конечной точке и конечная точка к сетевому устройству egress. В каждом случае есть дополнительная диаграмма, показывающая ускоренный TCP-путь, доступный при включенном socket layer enforcement.
