https://docs.cilium.io/en/latest/network/ebpf/lifeofapacket/

Endpoint to Endpoint (От конечной точки к конечной точке)
Сначала рассмотрим поток данных между локальными конечными точками (endpoint) с опциональной L7 Policy на исходящем (egress) и входящем (ingress) трафике. Затем покажем тот же поток, но с включенным socket layer enforcement.

Без socket layer enforcement:

Весь трафик проходит через endpoint policy object для проверки политик.

С socket layer enforcement (для TCP):

Конечные точки проходят проверку в endpoint policy object только до установки состояния ESTABLISHED.

После установки соединения требуется только L7 Policy object (если настроено).

Egress from Endpoint (Исходящий трафик от конечной точки)
Далее рассмотрим передачу данных от локальной конечной точки к внешней сети (egress) с опциональным overlay-туннелем.

С overlay-сетью:

Трафик перенаправляется через сетевой интерфейс overlay (по умолчанию — cilium_vxlan).

С socket layer enforcement:

Если используется L7-прокси, для TCP-трафика можно избежать проверки в endpoint policy block между endpoint и L7 Policy.

Шифрование (опционально):

Если включен L3 encryption block, пакет будет зашифрован перед отправкой.

Ingress to Endpoint (Входящий трафик к конечной точке)
Наконец, рассмотрим входящий трафик к локальной конечной точке, также с опциональным overlay.

С socket layer enforcement:

Позволяет избежать повторных проверок политик между прокси и сокетом конечной точки.

Если пакет зашифрован:

Сначала он расшифровывается, затем обрабатывается по стандартному потоку.

Ключевые моменты
Socket Layer Enforcement ускоряет TCP-трафик, минимизируя проверки после установки соединения.

Overlay (например, VXLAN) используется, если узлы не находятся в одной L2-сети.

L3 Encryption добавляет шифрование на уровне IPsec без изменения логики маршрутизации.
