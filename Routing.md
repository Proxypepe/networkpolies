Инкапсуляция
Если конфигурация не задана, Cilium автоматически работает в этом режиме, так как он предъявляет минимальные требования к базовой сетевой инфраструктуре.

В этом режиме все узлы кластера образуют mesh-сеть туннелей, используя UDP-инкапсуляционные протоколы VXLAN или Geneve. Весь трафик между узлами Cilium инкапсулируется.

Требования к сети
Инкапсуляция работает при наличии обычной связности между узлами. Это означает, что если узлы Cilium уже могут взаимодействовать друг с другом, все требования маршрутизации уже выполнены.

Базовая сеть должна поддерживать IPv4 (см. GitHub Issue 17240 для информации о поддержке IPv6 в туннелировании).

Базовая сеть и межсетевые экраны должны пропускать инкапсулированные пакеты:

Режим инкапсуляции	Диапазон портов / Протокол
VXLAN (по умолчанию)	8472/UDP
Geneve	6081/UDP
Преимущества модели
Простота

Сеть, соединяющая узлы кластера, не должна знать о PodCIDR.

Узлы кластера могут создавать несколько доменов маршрутизации или канального уровня.

Топология базовой сети не имеет значения, если узлы могут связываться через IP/UDP.

Адресное пространство

Поскольку модель не зависит от ограничений базовой сети, доступное адресное пространство потенциально значительно больше.

Позволяет запускать любое количество подов на узле (если размер PodCIDR настроен соответствующим образом).

Автоматическая настройка

При работе с системами оркестрации (например, Kubernetes) каждый агент автоматически получает список всех узлов кластера, включая их префиксы выделения.

Новые узлы, присоединяющиеся к кластеру, автоматически включаются в mesh-сеть.

Контекст идентификации

Протоколы инкапсуляции позволяют передавать метаданные вместе с сетевым пакетом.

Cilium использует эту возможность для передачи метаданных, таких как идентификатор безопасности источника.

Передача идентификатора — это оптимизация, позволяющая избежать дополнительного запроса идентификации на удалённом узле.

Недостатки модели
Накладные расходы на MTU

Из-за добавления заголовков инкапсуляции эффективный MTU для полезной нагрузки меньше, чем при нативной маршрутизации (дополнительные 50 байт на пакет для VXLAN).

Это снижает максимальную пропускную способность для конкретного сетевого соединения.

Эффект можно смягчить, включив jumbo frames (50 байт накладных расходов на 1500 байт против 50 байт на 9000 байт).


Нативная маршрутизация (Native Routing Mode)
В режиме нативной маршрутизации Cilium передает все пакеты, не предназначенные для локальных конечных точек (endpoints), подсистеме маршрутизации ядра Linux. Это означает, что пакеты обрабатываются так же, как если бы их отправил локальный процесс. В результате сеть, соединяющая узлы кластера, должна поддерживать маршрутизацию PodCIDR.

При использовании нативной маршрутизации Cilium автоматически включает IP-форвардинг в ядре Linux.

Требования к сети
Для работы в режиме нативной маршрутизации сеть между узлами Cilium должна уметь перенаправлять IP-трафик с адресами, назначенными подам или другим рабочим нагрузкам.

Ядро Linux на узле должно знать, как маршрутизировать пакеты подов и других рабочих нагрузок со всех узлов Cilium. Это можно реализовать двумя способами:

Маршрутизация через шлюз

Узел сам не знает маршруты ко всем IP-адресам подов, но в сети есть маршрутизатор, который знает, как до них добраться.

В этом случае на узле Linux настраивается маршрут по умолчанию, указывающий на такой маршрутизатор.

Эта модель используется при интеграции с облачными провайдерами (см. Google Cloud, AWS ENI, Azure IPAM).

Распределение маршрутов между узлами

Каждый узел знает все IP-адреса подов других узлов, и соответствующие маршруты добавляются в таблицу маршрутизации ядра Linux.

Если все узлы находятся в одной L2-сети, можно включить опцию:

yaml
auto-direct-node-routes: true
В противном случае требуется дополнительный компонент (например, BGP-демон) для распространения маршрутов.

Пример настройки BGP через kube-router (устаревший метод) можно найти в руководстве:

Конфигурация
Для включения режима нативной маршрутизации необходимо задать следующие параметры:

Обязательные настройки
yaml
routing-mode: native                  # Включение нативной маршрутизации  
ipv4-native-routing-cidr: x.x.x.x/y   # Указание CIDR, в котором работает нативная маршрутизация  
Опциональные настройки
yaml
direct-routing-skip-unreachable: true  
Полезно, если в кластере несколько L2-подсетей, и используется BGP-демон.

Позволяет узлам напрямую связываться внутри своей зоны без обязательного прохождения трафика через BGP-маршрутизаторы.

Ключевые особенности
Производительность: Нет накладных расходов на инкапсуляцию (в отличие от VXLAN/Geneve).

Гибкость: Подходит для сложных сетевых топологий, включая гибридные и мультиоблачные среды.

Зависимость от инфраструктуры: Требуется корректная настройка маршрутизации в базовой сети.
